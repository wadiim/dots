#!/usr/bin/env bash

# REQUIRES: bash, tmux

common_chars='_#$%&+=@-'

start_delim='(^|[[:space:]"])'
path_prefix='(\.|\.\.|~)'
fd_char="[[:alnum:].$common_chars]"
non_num_fd_char="[[:alpha:].$common_chars]"
fd_name="$fd_char+"
non_num_fd_name="$fd_char?$non_num_fd_char+$fd_char?"

path_body="($fd_name/){1,}(/$non_num_fd_name)+(/$fd_name){0,}|\
($non_num_fd_name/)+($fd_name/){1,}"

ext="\.[[:alnum:]$common_chars]+"
line_no='(:[0-9]+)'
loc="($line_no$line_no?)"
path_end='($|[[:space:]"/])'

prefixed_path="($path_prefix(/$fd_name)+$loc?$path_end?)"
non_prefixed_abs_path="((/$fd_name)+$loc?$path_end?)"
non_prefixed_lc_rel_path="($fd_name(/$fd_name)+$loc$path_end?)"
non_prefixed_non_lc_rel_path_with_ext="($fd_name(/$fd_name)+$ext$path_end)"
non_prefixed_non_lc_rel_path_without_ext="($path_body$path_end)"

# Matches `rg --vimgrep` style LC paths, consisting only of a filename with
# extension. It requires the column number, unlike other matchers.
non_prefixed_lc_basename_with_ext="(^($fd_char)+$ext$line_no$line_no)"

matcher="($start_delim(\
$prefixed_path|\
$non_prefixed_abs_path|\
$non_prefixed_lc_rel_path|\
$non_prefixed_non_lc_rel_path_with_ext|\
$non_prefixed_non_lc_rel_path_without_ext\
))|$non_prefixed_lc_basename_with_ext"

# Returns the ID of the tmux pane that the script is executed in.
get_tmux_curr_pane_id() {
    tmux display-message -p "#{pane_id}"
}

# Returns the cursor Y position in copy mode.
get_tmux_cursor_row() {
    tmux display-message -p "#{copy_cursor_y}"
}

# Returns a single integer representing the scroll position in copy mode.
get_tmux_scroll_pos() {
    tmux display-message -p "#{scroll_position}"
}

# Enters the copy mode in the current tmux pane.
enter_tmux_copy_mode() {
    tmux copy-mode
}

# Moves the cursor to the beginning of the previous prompt. It assumes that
# the shell emits prompts that starts with the FTCS_PROMPT sequence and
# that the current tmux pane is in copy mode. If there is no shell prompt in
# the current buffer, moves to the beginning of the buffer instead.
jump_to_previous_prompt() {
    start_offset="$( get_tmux_scroll_pos )"
    start_row="$( get_tmux_cursor_row )"

    tmux send-keys -X previous-prompt

    end_offset="$( get_tmux_scroll_pos )"
    end_row="$( get_tmux_cursor_row )"

    if (( start_offset == end_offset )) && (( start_row == end_row )); then
        tmux send-keys -X history-top
    fi
}

# Selects file paths between the current position and the end of the buffer,
# starting from the first one.
select_paths() {
    tmux send-keys -X search-forward "$matcher"
}

# Selects file paths between the current position and the beginning of the
# buffer, starting from the last one.
select_paths_backward() {
    tmux send-keys -X search-backward "$matcher"
}

if (( "${#@}" < 1 )); then
    enter_tmux_copy_mode
    jump_to_previous_prompt
    select_paths
elif [[ "$1" == "-r" ]]; then
    enter_tmux_copy_mode
    select_paths_backward
elif [[ "$1" == "-p" ]]; then
    echo "$matcher"
fi
