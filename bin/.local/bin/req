#!/bin/bash

# A dependency aggregator.
#
# Usage:
#   req [starting-point...]
#
# It recursively collects dependencies from all files under each
# starting-point or under current working directory if no starting-point was
# provided. The output is a space-separated list of dependencies without
# duplicates. The dependency specification must be a comma-separated list of
# names, preceded by `REQUIRES: ` (note the trailing space), e.g.:
#   REQUIRES: foo, bar, baz
# The dependency specification does not need to be on a line on its own, but
# every item after `REQUIRES: ` is treated as a dependency name. This means
# that the dependency specifications can be embedded in scripts or
# configuration files using comments. Files containing
# `DISABLE_REQUESTS_AGGREGATION` tag are ignored.

paths="."
if (( ${#@} > 0 )); then
    paths="$@"
fi

get_files_under_dir() {
    find "$1" -type f -readable ! -path "*.git*"
}

is_file_ignored() {
    grep -qF 'DISABLE_REQUESTS_AGGREGATION' "$1"
}

get_reqs_from_dir() {
    for file in $( get_files_under_dir "$1" ); do
        if ! is_file_ignored "$file"; then
            grep -ho 'REQUIRES: \(.*\)' "$file"
        fi
    done | cut -d" " -f 2- | sed 's/ \|, \?/\n/g'
}

for dir in $paths; do
    get_reqs_from_dir "$dir"
done | sort | uniq | tr '\n' ' ' && echo ""
